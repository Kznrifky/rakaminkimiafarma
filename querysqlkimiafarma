Query Membuat Tabel Awal 

WITH rating_cabang_summary AS (
  SELECT
    branch_id,
    AVG(rating) AS rating_cabang
  FROM
    `rakamin-kf-analytics-467203.kimia_farma.kf_final_transaction`
  GROUP BY
    branch_id
)

SELECT
  t.customer_name,
  t.product_id,
  p.product_name,
  t.price AS actual_price,
  t.discount_percentage,

  -- Hitung persentase gross laba
  CASE
    WHEN t.price <= 50000 THEN 0.10
    WHEN t.price <= 100000 THEN 0.15
    WHEN t.price <= 300000 THEN 0.20
    WHEN t.price <= 500000 THEN 0.25
    ELSE 0.30
  END AS persentase_gross_laba,

  -- Harga setelah diskon
  t.price * (1 - t.discount_percentage) AS nett_sales,

  -- Keuntungan bersih
  t.price * (1 - t.discount_percentage) *
  CASE
    WHEN t.price <= 50000 THEN 0.10
    WHEN t.price <= 100000 THEN 0.15
    WHEN t.price <= 300000 THEN 0.20
    WHEN t.price <= 500000 THEN 0.25
    ELSE 0.30
  END AS nett_profit,

  -- Tambahan kolom penting untuk dashboard
  t.rating AS rating_transaksi,
  rc.rating_cabang,
  t.date AS transaction_date,
  EXTRACT(YEAR FROM t.date) AS year,
  b.branch_name,
  b.provinsi,
  b.kota

FROM
  `rakamin-kf-analytics-467203.kimia_farma.kf_final_transaction` AS t
JOIN
  `rakamin-kf-analytics-467203.kimia_farma.kf_kantor_cabang` AS b
  ON t.branch_id = b.branch_id
JOIN
  `rakamin-kf-analytics-467203.kimia_farma.kf_product` AS p
  ON t.product_id = p.product_id
LEFT JOIN
  rating_cabang_summary AS rc
  ON t.branch_id = rc.branch_id

Query 10 Provinsi 

SELECT
  kc.provinsi,
  COUNT(*) AS total_transaksi
FROM
  `rakamin-kf-analytics-467203.kimia_farma.kf_final_transaction` AS tr
JOIN
  `rakamin-kf-analytics-467203.kimia_farma.kf_kantor_cabang` AS kc
ON
  tr.branch_id = kc.branch_id
GROUP BY
  kc.provinsi
ORDER BY
  total_transaksi DESC

Query 10 Nett Sales 

SELECT
  provinsi,
  SUM(nett_sales) AS total_nett_sales
FROM
  `rakamin-kf-analytics-467203.kimia_farma.analisa_kinerja`
GROUP BY
  provinsi
ORDER BY
  total_nett_sales DESC
LIMIT 10

Query Cabang Terbaik 

WITH top_rating_cabang AS (
  SELECT
    branch_name,
    provinsi,
    MAX(rating_cabang) AS rating_cabang,
    ROUND(AVG(rating_transaksi), 2) AS rata_rating_transaksi
  FROM
    `kimia_farma.analisa_kinerja`
  WHERE
    rating_transaksi IS NOT NULL
  GROUP BY
    branch_name, provinsi
  ORDER BY
    rating_cabang DESC
  LIMIT 5
)

SELECT *
FROM top_rating_cabang
ORDER BY rata_rating_transaksi ASC;

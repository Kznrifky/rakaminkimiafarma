-- Query SQL PBI Rakamin Academy

WITH BaseData AS (
  SELECT
    t.customer_name,
    t.product_id,
    p.product_name,
    t.price AS actual_price,
    t.discount_percentage,
    t.rating AS rating_transaksi,
    t.date AS transaction_date,
    t.branch_id,
    b.branch_name,
    b.provinsi,
    b.kota,
    ROUND(AVG(t.rating) OVER (PARTITION BY t.branch_id), 2) AS rating_cabang
  FROM
    `rakamin-kf-analytics-467203.kimia_farma.kf_final_transaction` t
  JOIN
    `rakamin-kf-analytics-467203.kimia_farma.kf_kantor_cabang` b
    ON t.branch_id = b.branch_id
  JOIN
    `rakamin-kf-analytics-467203.kimia_farma.kf_product` p
    ON t.product_id = p.product_id
),

CalculatedData AS (
  SELECT
    *,
    CASE
      WHEN actual_price <= 50000 THEN 0.10
      WHEN actual_price <= 100000 THEN 0.15
      WHEN actual_price <= 300000 THEN 0.20
      WHEN actual_price <= 500000 THEN 0.25
      ELSE 0.30
    END AS persentase_gross_laba
  FROM BaseData
)

SELECT
  customer_name,
  product_id,
  product_name,
  actual_price,
  discount_percentage,
  persentase_gross_laba,
  (actual_price * (1 - discount_percentage/100)) AS nett_sales,
  ((actual_price * (1 - discount_percentage/100)) * persentase_gross_laba) AS nett_profit,
  rating_transaksi,
  rating_cabang,
  transaction_date,
  EXTRACT(YEAR FROM transaction_date) AS year,
  branch_name,
  provinsi,
  kota
FROM CalculatedData;
